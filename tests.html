<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dictionary Tests</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    .test-suite { margin: 20px 0; }
    .test-suite h2 { color: #4fc3f7; }
    .test { padding: 8px; margin: 4px 0; border-left: 3px solid #666; }
    .test.pass { background: #1a3d1a; border-color: #4caf50; }
    .test.fail { background: #3d1a1a; border-color: #f44336; }
    .test-name { font-weight: bold; }
    .test-error { color: #ff6b6b; margin-top: 4px; font-size: 0.9em; }
    .summary { margin: 20px 0; padding: 15px; background: #2d2d2d; border-radius: 4px; }
    .summary.success { border-left: 4px solid #4caf50; }
    .summary.failure { border-left: 4px solid #f44336; }
  </style>
</head>
<body>
  <h1>ðŸ§ª Chinese Dictionary Test Suite</h1>
  <div id="results"></div>
  <div id="summary"></div>

<script>
// Simple test framework
const tests = [];
let passCount = 0;
let failCount = 0;

function test(name, fn) {
  tests.push({ name, fn });
}

function assertEqual(actual, expected, message = '') {
  if (JSON.stringify(actual) !== JSON.stringify(expected)) {
    throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}. ${message}`);
  }
}

function assertTrue(value, message = '') {
  if (!value) {
    throw new Error(`Expected true, got ${value}. ${message}`);
  }
}

function assertFalse(value, message = '') {
  if (value) {
    throw new Error(`Expected false, got ${value}. ${message}`);
  }
}

function assertContains(array, item, message = '') {
  if (!array.some(el => JSON.stringify(el) === JSON.stringify(item))) {
    throw new Error(`Expected array to contain ${JSON.stringify(item)}. ${message}`);
  }
}

function assertGreaterThan(actual, expected, message = '') {
  if (actual <= expected) {
    throw new Error(`Expected ${actual} to be greater than ${expected}. ${message}`);
  }
}

function assertLessThan(actual, expected, message = '') {
  if (actual >= expected) {
    throw new Error(`Expected ${actual} to be less than ${expected}. ${message}`);
  }
}

function runTests() {
  const resultsDiv = document.getElementById('results');
  const summaryDiv = document.getElementById('summary');

  tests.forEach(({ name, fn }) => {
    const testDiv = document.createElement('div');
    testDiv.className = 'test';

    try {
      fn();
      testDiv.classList.add('pass');
      testDiv.innerHTML = `<div class="test-name">âœ“ ${name}</div>`;
      passCount++;
    } catch (error) {
      testDiv.classList.add('fail');
      testDiv.innerHTML = `
        <div class="test-name">âœ— ${name}</div>
        <div class="test-error">${error.message}</div>
      `;
      failCount++;
    }

    resultsDiv.appendChild(testDiv);
  });

  const total = passCount + failCount;
  const passRate = ((passCount / total) * 100).toFixed(1);

  summaryDiv.className = `summary ${failCount === 0 ? 'success' : 'failure'}`;
  summaryDiv.innerHTML = `
    <strong>Summary:</strong> ${passCount}/${total} tests passed (${passRate}%)
    ${failCount > 0 ? `<br><strong style="color: #f44336;">${failCount} test(s) failed</strong>` : ''}
  `;
}

// =============================================================================
// TEST DATA
// =============================================================================

const testDictionary = [
  {
    simplified: "ä½ å¥½",
    traditional: "ä½ å¥½",
    pinyin: "ni3 hao3",
    pinyinSearchable: "ni hao",
    pinyinWithTones: "ni3 hao3",
    english: ["hello", "hi"],
    searchableEnglish: "hello/hi"
  },
  {
    simplified: "å­¦ä¹ ",
    traditional: "å­¸ç¿’",
    pinyin: "xue2 xi2",
    pinyinSearchable: "xue xi",
    pinyinWithTones: "xue2 xi2",
    english: ["to study", "to learn"],
    searchableEnglish: "to study/to learn"
  },
  {
    simplified: "ä¸­æ–‡",
    traditional: "ä¸­æ–‡",
    pinyin: "zhong1 wen2",
    pinyinSearchable: "zhong wen",
    pinyinWithTones: "zhong1 wen2",
    english: ["Chinese language"],
    searchableEnglish: "chinese language"
  },
  {
    simplified: "ç”µè„‘",
    traditional: "é›»è…¦",
    pinyin: "dian4 nao3",
    pinyinSearchable: "dian nao",
    pinyinWithTones: "dian4 nao3",
    english: ["computer"],
    searchableEnglish: "computer"
  },
  {
    simplified: "å¥½",
    traditional: "å¥½",
    pinyin: "hao3",
    pinyinSearchable: "hao",
    pinyinWithTones: "hao3",
    english: ["good", "well", "proper"],
    searchableEnglish: "good/well/proper"
  }
];

// =============================================================================
// COPY FUNCTIONS FROM index.php FOR TESTING
// =============================================================================

let dictionary = testDictionary; // Use test data instead of loading

function splitPinyinIntoSyllables(input) {
  const syllables = [
    "a","ai","an","ang","ao","ba","bai","ban","bang","bao","bei","ben","beng","bi","bian","biao","bie","bin","bing","bo",
    "bu","ca","cai","can","cang","cao","ce","cen","ceng","cha","chai","chan","chang","chao","che","chen","cheng","chi",
    "chong","chou","chu","chua","chuai","chuan","chuang","chui","chun","chuo","ci","cong","cou","cu","cuan","cui","cun",
    "cuo","da","dai","dan","dang","dao","de","dei","den","deng","di","dia","dian","diao","die","ding","diu","dong","dou",
    "du","duan","dui","dun","duo","e","ei","en","eng","er","fa","fan","fang","fei","fen","feng","fo","fou","fu","ga","gai",
    "gan","gang","gao","ge","gei","gen","geng","gong","gou","gu","gua","guai","guan","guang","gui","gun","guo","ha","hai",
    "han","hang","hao","he","hei","hen","heng","hong","hou","hu","hua","huai","huan","huang","hui","hun","huo","ji","jia",
    "jian","jiang","jiao","jie","jin","jing","jiong","jiu","ju","juan","jue","jun","ka","kai","kan","kang","kao","ke","ken",
    "keng","kong","kou","ku","kua","kuai","kuan","kuang","kui","kun","kuo","la","lai","lan","lang","lao","le","lei","leng",
    "li","lia","lian","liang","liao","lie","lin","ling","liu","long","lou","lu","lv","luan","lue","lun","luo","ma","mai",
    "man","mang","mao","me","mei","men","meng","mi","mian","miao","mie","min","ming","miu","mo","mou","mu","na","nai",
    "nan","nang","nao","ne","nei","nen","neng","ni","nian","niang","niao","nie","nin","ning","niu","nong","nou","nu",
    "nv","nuan","nue","nuo","o","ou","pa","pai","pan","pang","pao","pei","pen","peng","pi","pian","piao","pie","pin",
    "ping","po","pou","pu","qi","qia","qian","qiang","qiao","qie","qin","qing","qiong","qiu","qu","quan","que","qun",
    "ran","rang","rao","re","ren","reng","ri","rong","rou","ru","ruan","rui","run","ruo","sa","sai","san","sang","sao",
    "se","sen","seng","sha","shai","shan","shang","shao","she","shen","sheng","shi","shou","shu","shua","shuai","shuan",
    "shuang","shui","shun","shuo","si","song","sou","su","suan","sui","sun","suo","ta","tai","tan","tang","tao","te",
    "teng","ti","tian","tiao","tie","ting","tong","tou","tu","tuan","tui","tun","tuo","wa","wai","wan","wang","wei",
    "wen","weng","wo","wu","xi","xia","xian","xiang","xiao","xie","xin","xing","xiong","xiu","xu","xuan","xue","xun",
    "ya","yan","yang","yao","ye","yi","yin","ying","yo","yong","you","yu","yuan","yue","yun","za","zai","zan","zang",
    "zao","ze","zei","zen","zeng","zha","zhai","zhan","zhang","zhao","zhe","zhen","zheng","zhi","zhong","zhou","zhu",
    "zhua","zhuai","zhuan","zhuang","zhui","zhun","zhuo","zi","zong","zou","zu","zuan","zui","zun","zuo"
  ];
  let inputLower = input.toLowerCase();
  let result = [];
  let i = 0;
  while (i < inputLower.length) {
    let found = false;
    for (let len = Math.min(5, inputLower.length - i); len >= 1; len--) {
      let substr = inputLower.slice(i, i + len);
      if (syllables.includes(substr)) {
        result.push(substr);
        i += len;
        found = true;
        break;
      }
    }
    if (!found) {
      return null;
    }
  }
  return result.join(' ');
}

function searchPinyin(query) {
  let lower = query.toLowerCase().trim();
  let splitAttempt = null;
  let split = lower;

  if (!lower.includes(' ')) {
    splitAttempt = splitPinyinIntoSyllables(lower);
    if (splitAttempt) split = splitAttempt;
  }

  let searchTerms = [];
  if (lower) searchTerms.push(lower);
  if (split && split !== lower) searchTerms.push(split);

  let variants = [];
  for (const term of searchTerms) {
    variants.push(term.replace(/\s+/g, ''));
    variants.push(term.replace(/\s+/g, ' '));
  }
  variants = Array.from(new Set(variants));

  const hasTones = /\d/.test(lower);

  const results = [];
  dictionary.forEach(entry => {
    if (!entry.pinyin) return;
    const entryPinyinWithTones = entry.pinyinWithTones.trim();
    const entryPinyinNoTones = entry.pinyinSearchable.trim();
    const entryPinyinWithTonesNoSpaces = entryPinyinWithTones.replace(/\s+/g, '');
    const entryPinyinNoTonesNoSpaces = entryPinyinNoTones.replace(/\s+/g, '');

    let matched = false;
    for (const term of variants) {
      const termNoSpaces = term.replace(/\s+/g, '');

      if (hasTones) {
        if (entryPinyinWithTones === term ||
            entryPinyinWithTonesNoSpaces === termNoSpaces ||
            entryPinyinWithTones.includes(term) ||
            entryPinyinWithTonesNoSpaces.includes(termNoSpaces)) {
          matched = true;
          break;
        }
      } else {
        if (entryPinyinNoTones === term ||
            entryPinyinNoTonesNoSpaces === termNoSpaces ||
            entryPinyinNoTones.includes(term) ||
            entryPinyinNoTonesNoSpaces.includes(termNoSpaces)) {
          matched = true;
          break;
        }
      }
    }
    if (matched) results.push(entry);
  });

  return results.sort((a,b) => a.simplified.length - b.simplified.length).slice(0, 100);
}

function searchChinese(query) {
  const results = [];
  const cleanQuery = query.replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€\s]/g,'');
  dictionary.forEach(entry => {
    if (entry.simplified === cleanQuery || entry.traditional === cleanQuery)
      results.push({...entry, exactMatch:true});
    else if (cleanQuery.length===1 && (entry.simplified.includes(cleanQuery)||entry.traditional.includes(cleanQuery)))
      results.push({...entry, exactMatch:false});
  });
  return results.sort((a,b) => (a.exactMatch&&!b.exactMatch?-1:!a.exactMatch&&b.exactMatch?1:a.simplified.length-b.simplified.length)).slice(0,100).map(r=>{delete r.exactMatch;return r;});
}

function searchEnglish(query) {
  const results = [], searchTerms = query.toLowerCase().trim().split(/\s+/);
  dictionary.forEach(entry => {
    if (!entry.searchableEnglish) return;
    const matches = searchTerms.some(term => term.length<=2 ? new RegExp(`\\b${term}\\b`,'i').test(entry.searchableEnglish) : entry.searchableEnglish.includes(term));
    if(matches){
      const matchCount = searchTerms.filter(term=>entry.searchableEnglish.includes(term)).length;
      results.push({...entry, relevance:matchCount*10+calculateRelevance(entry.searchableEnglish,searchTerms)});
    }
  });
  return results.sort((a,b)=>b.relevance-a.relevance).slice(0,100).map(r=>{delete r.relevance;return r;});
}

function calculateRelevance(text,searchTerms) {
  let score=0;
  searchTerms.forEach(term=>{
    const wordRegex=new RegExp(`\\b${term}\\b`,'gi');
    score+=(text.match(wordRegex)||[]).length*10;
    score+=(text.match(new RegExp(term,'gi'))||[]).length;
  });
  score-=text.length*0.01;
  return score;
}

function detectInputType(text) {
  const chineseRegex = /[\u4e00-\u9fff\u3400-\u4dbf]/;
  if (chineseRegex.test(text)) return 'chinese';
  const cleanText = text.toLowerCase().trim();
  const pinyinRegex = /^[a-z]+[0-5]?(\s+[a-z]+[0-5]?)*$/;
  const commonEnglish = ['a','i','me','you','he','she','it','we','they','can','will','would','should'];
  if (pinyinRegex.test(cleanText) && !commonEnglish.includes(cleanText)) {
    if (/[0-5]/.test(cleanText)) return 'pinyin';
    const syllables = cleanText.split(/\s+/);
    const pinyinPatterns = /^(zh|ch|sh|[bpmfdtnlgkhjqxrzcsyw])?[aeiouÃ¼]+n?g?$/;
    const likelyPinyin = syllables.every(syl => pinyinPatterns.test(syl));
    return likelyPinyin ? 'pinyin' : 'english';
  }
  return 'english';
}

// =============================================================================
// TESTS
// =============================================================================

// --- Pinyin Splitting Tests ---
test('splitPinyinIntoSyllables: "nihao" â†’ "ni hao"', () => {
  assertEqual(splitPinyinIntoSyllables('nihao'), 'ni hao');
});

test('splitPinyinIntoSyllables: "zhongwen" â†’ "zhong wen"', () => {
  assertEqual(splitPinyinIntoSyllables('zhongwen'), 'zhong wen');
});

test('splitPinyinIntoSyllables: "xuexi" â†’ "xue xi"', () => {
  assertEqual(splitPinyinIntoSyllables('xuexi'), 'xue xi');
});

test('splitPinyinIntoSyllables: invalid input returns null', () => {
  assertEqual(splitPinyinIntoSyllables('xyz123'), null);
});

test('splitPinyinIntoSyllables: empty string returns empty', () => {
  assertEqual(splitPinyinIntoSyllables(''), '');
});

// --- Input Type Detection Tests ---
test('detectInputType: Chinese characters â†’ "chinese"', () => {
  assertEqual(detectInputType('ä½ å¥½'), 'chinese');
  assertEqual(detectInputType('å­¦ä¹ ä¸­æ–‡'), 'chinese');
});

test('detectInputType: Pinyin with tones â†’ "pinyin"', () => {
  assertEqual(detectInputType('ni3 hao3'), 'pinyin');
  assertEqual(detectInputType('xue2xi2'), 'pinyin');
});

test('detectInputType: Pinyin without tones â†’ "pinyin"', () => {
  assertEqual(detectInputType('nihao'), 'pinyin');
  assertEqual(detectInputType('zhong wen'), 'pinyin');
});

test('detectInputType: English words â†’ "english"', () => {
  assertEqual(detectInputType('hello'), 'english');
  assertEqual(detectInputType('computer'), 'english');
  assertEqual(detectInputType('study chinese'), 'english');
});

test('detectInputType: common English words not mistaken as pinyin', () => {
  assertEqual(detectInputType('me'), 'english');
  assertEqual(detectInputType('you'), 'english');
});

// --- Chinese Search Tests ---
test('searchChinese: exact match "ä½ å¥½"', () => {
  const results = searchChinese('ä½ å¥½');
  assertEqual(results.length, 1);
  assertEqual(results[0].simplified, 'ä½ å¥½');
});

test('searchChinese: exact match "å­¦ä¹ "', () => {
  const results = searchChinese('å­¦ä¹ ');
  assertEqual(results.length, 1);
  assertEqual(results[0].simplified, 'å­¦ä¹ ');
});

test('searchChinese: single character "å¥½" finds matches', () => {
  const results = searchChinese('å¥½');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'å¥½'));
});

test('searchChinese: no match returns empty', () => {
  const results = searchChinese('ä¸å­˜åœ¨çš„è¯');
  assertEqual(results.length, 0);
});

// --- Pinyin Search Tests ---
test('searchPinyin: "ni hao" finds "ä½ å¥½"', () => {
  const results = searchPinyin('ni hao');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchPinyin: "nihao" finds "ä½ å¥½"', () => {
  const results = searchPinyin('nihao');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchPinyin: "ni3hao3" with tones finds "ä½ å¥½"', () => {
  const results = searchPinyin('ni3hao3');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchPinyin: "xue xi" finds "å­¦ä¹ "', () => {
  const results = searchPinyin('xue xi');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'å­¦ä¹ '));
});

test('searchPinyin: partial match "hao" finds words containing it', () => {
  const results = searchPinyin('hao');
  assertGreaterThan(results.length, 0);
});

// --- English Search Tests ---
test('searchEnglish: "hello" finds "ä½ å¥½"', () => {
  const results = searchEnglish('hello');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchEnglish: "computer" finds "ç”µè„‘"', () => {
  const results = searchEnglish('computer');
  assertEqual(results.length, 1);
  assertEqual(results[0].simplified, 'ç”µè„‘');
});

test('searchEnglish: "study" finds "å­¦ä¹ "', () => {
  const results = searchEnglish('study');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'å­¦ä¹ '));
});

test('searchEnglish: "chinese language" finds "ä¸­æ–‡"', () => {
  const results = searchEnglish('chinese language');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä¸­æ–‡'));
});

test('searchEnglish: no match returns empty', () => {
  const results = searchEnglish('nonexistent');
  assertEqual(results.length, 0);
});

// --- Relevance Scoring Tests ---
test('calculateRelevance: exact word match scores higher', () => {
  const score1 = calculateRelevance('computer', ['computer']);
  const score2 = calculateRelevance('computer science', ['computer']);
  assertGreaterThan(score1, 0);
  assertGreaterThan(score2, 0);
});

test('calculateRelevance: multiple term matches score higher', () => {
  const score1 = calculateRelevance('to study and learn', ['study', 'learn']);
  const score2 = calculateRelevance('to study', ['study']);
  assertGreaterThan(score1, score2);
});

// --- Edge Cases ---
test('searchChinese: handles punctuation', () => {
  const results = searchChinese('ä½ å¥½ï¼Œ');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchPinyin: handles extra whitespace', () => {
  const results = searchPinyin('  ni  hao  ');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchEnglish: handles case insensitivity', () => {
  const results = searchEnglish('HELLO');
  assertGreaterThan(results.length, 0);
  assertTrue(results.some(r => r.simplified === 'ä½ å¥½'));
});

test('searchPinyin: returns max 100 results', () => {
  // Create a dictionary with 150 entries that match
  const largeDictionary = [];
  for (let i = 0; i < 150; i++) {
    largeDictionary.push({
      simplified: `æµ‹${i}`,
      traditional: `æ¸¬${i}`,
      pinyin: `hao3`,
      pinyinSearchable: 'hao',
      pinyinWithTones: 'hao3',
      english: ['test'],
      searchableEnglish: 'test'
    });
  }
  const originalDict = dictionary;
  dictionary = largeDictionary;

  const results = searchPinyin('hao');
  assertEqual(results.length, 100);

  dictionary = originalDict;
});

// Run all tests
runTests();
</script>
</body>
</html>
